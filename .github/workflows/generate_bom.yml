name: Auto Generate BOM

on:
  push:
    # Se déclenche si des fichiers changent dans le dossier stl ou si on édite le JSON
    paths:
      - 'stl/**'
      - 'print_settings.json'
      - 'generate_bom.py'
  workflow_dispatch: # Permet de le lancer manuellement depuis l'onglet Actions

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Crucial pour permettre à l'action de modifier ton dépôt

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Run BOM Script
        run: python generate_bom.py

      - name: Inject BOM into README
        run: |
          # Lit BOM.md, l'échappe pour le script, et l'insère entre les balises du README
          BOM_CONTENT=$(cat BOM.md)
          perl -i -0777 -pe "s/(<!-- BOM_START -->).*(<!-- BOM_END -->)/\$1\n$BOM_CONTENT\n\$2/sg" README.md

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style: mise à jour automatique de la nomenclature (BOM)"
          file_pattern: 'BOM.md print_settings.json'
          commit_author_email: "actions@github.com"
          commit_author_name: "GitHub Actions Bot"
