name: Auto Generate BOM

on:
  push:
    # Se déclenche si des fichiers changent dans le dossier stl ou si on édite le JSON
    paths:
      - 'stl/**'
      - 'print_settings.json'
      - 'generate_bom.py'
  workflow_dispatch: # Permet de le lancer manuellement depuis l'onglet Actions

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Crucial pour permettre à l'action de modifier ton dépôt

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Run BOM Script
        run: python generate_bom.py

      - name: Update README with BOM content
        run: |
          # 1. Extraire le haut du README (jusqu'à la balise START incluse)
          sed -i '/<!-- BOM_START -->/q' README.md
          
          # 2. Créer un fichier temporaire avec le haut + le contenu du BOM
          cat README.md > README.new
          echo "" >> README.new
          cat BOM.md >> README.new
          echo "" >> README.new
          
          # 3. Ajouter la balise de fin et le reste du document original
          echo "<!-- BOM_END -->" >> README.new
          
          # 4. Remplacer le README
          mv README.new README.md


      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style: mise à jour automatique de la nomenclature (BOM)"
          file_pattern: 'BOM.md print_settings.json'
          commit_author_email: "actions@github.com"
          commit_author_name: "GitHub Actions Bot"
