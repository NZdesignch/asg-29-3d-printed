name: Auto Generate BOM

on:
  push:
    # Se déclenche si des fichiers changent dans le dossier stl ou si on édite le JSON
    paths:
      - 'stl/**'
      - 'print_settings.json'
      - 'generate_bom.py'
  workflow_dispatch: # Permet de le lancer manuellement depuis l'onglet Actions

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Crucial pour permettre à l'action de modifier ton dépôt

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Run BOM Script
        run: python generate_bom.py

      - name: Update README with BOM content
        run: |
          # On crée un fichier temporaire pour reconstruire le README
          # On récupère tout ce qui est AVANT la balise START
          sed -n '1,/<!-- BOM_START -->/p' README.md > README.tmp
          
          # On ajoute le contenu de BOM.md
          cat BOM.md >> README.tmp
          
          # On ajoute tout ce qui est APRÈS la balise END
          sed -n '/<!-- BOM_END -->/,$p' README.md >> README.tmp
          
          # On remplace l'ancien README par le nouveau
          mv README.tmp README.md

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style: mise à jour automatique de la nomenclature (BOM)"
          file_pattern: 'BOM.md print_settings.json'
          commit_author_email: "actions@github.com"
          commit_author_name: "GitHub Actions Bot"
